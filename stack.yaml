version: 3.8

services:
  api:
    image: dekuyo/gobank-api:0.1
    secrets:
      - gobank_database_url
      - gobank_symmetric_key
      - gobank_database_migration_path
    environment:
      - DATABASE_DRIVER_FILE=${DATABASE_DRIVER}
      - DATABASE_URL_FILE==/run/secrets/gobank_database_url
      - SYMMETRIC_KEY_FILE=/run/secrets/gobank_symmetric_key
      - DATABASE_MIGRATION_PATH_FILE==/run/secrets/gobank_database_migration_path
    ports:
      - "9001:8000"
    extra_hosts:
          - "host.docker.internal:host-gateway"

  grpc:
    image: dekuyo/gobank-gapi:0.1
    secrets:
      - gobank_database_url
      - gobank_symmetric_key
      - gobank_database_migration_path
    environment:
      - DATABASE_DRIVER_FILE=${DATABASE_DRIVER}
      - DATABASE_URL_FILE==/run/secrets/gobank_database_url
      - SYMMETRIC_KEY_FILE=/run/secrets/gobank_symmetric_key
      - DATABASE_MIGRATION_PATH_FILE==/run/secrets/gobank_database_migration_path
    ports:
      - "9002:8000"
    extra_hosts:
          - "host.docker.internal:host-gateway"

  gateway:
    image: dekuyo/gobank-gateway:0.1
    secrets:
      - gobank_database_url
      - gobank_symmetric_key
      - gobank_database_migration_path
    environment:
      - DATABASE_DRIVER_FILE=${DATABASE_DRIVER}
      - DATABASE_URL_FILE==/run/secrets/gobank_database_url
      - SYMMETRIC_KEY_FILE=/run/secrets/gobank_symmetric_key
      - DATABASE_MIGRATION_PATH_FILE==/run/secrets/gobank_database_migration_path
    ports:
      - "9003:8000"
    extra_hosts:
          - "host.docker.internal:host-gateway"

secrets:
  gobank_database_url:
    external: true
  gobank_symmetric_key:
    external: true
  gobank_database_migration_path:
    external: true